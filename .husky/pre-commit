#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üîç Running pre-commit checks..."

# Check commit size
echo "üìè Checking commit size..."
STAGED_FILES=$(git diff --cached --numstat | awk '{ additions += $1; deletions += $2 } END { print additions + deletions }')

if [ -z "$STAGED_FILES" ]; then
  STAGED_FILES=0
fi

if [ "$STAGED_FILES" -gt 500 ]; then
  echo "‚ùå Commit too large: $STAGED_FILES lines (max 500)"
  echo "üí° Split your commit into smaller chunks"
  exit 1
fi

echo "‚úÖ Commit size OK: $STAGED_FILES lines"

# Check for secrets
echo "üîê Checking for secrets..."
if git diff --cached --name-only | xargs grep -l "PRIVATE_KEY.*=.*0x[a-fA-F0-9]" 2>/dev/null; then
  echo "‚ùå Hardcoded private key detected!"
  exit 1
fi

# Check for .env files
if git diff --cached --name-only | grep -E "\.env$|\.env\.local$"; then
  echo "‚ùå .env files should not be committed!"
  exit 1
fi

echo "‚úÖ No secrets detected"

# Run linting if available
if [ -f "package.json" ]; then
  echo "üé® Running linters..."
  npm run lint:all 2>/dev/null || echo "‚ö†Ô∏è  Linting not configured"
fi

echo "‚ú® Pre-commit checks passed!"

